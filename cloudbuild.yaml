steps:

  # 1) Build Docker
  - name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "europe-west1-docker.pkg.dev/$PROJECT_ID/hello-app/hello-app:latest", "."]
    id: "Build Docker"

  # 2) Push Docker
  - name: "gcr.io/cloud-builders/docker"
    args: ["push", "europe-west1-docker.pkg.dev/$PROJECT_ID/hello-app/hello-app:latest"]
    id: "Push Docker"
    waitFor: ["Build Docker"]

  # 3) Deploy Cloud Run
  - name: "gcr.io/cloud-builders/gcloud"
    args:
      [
        "run", "deploy", "hello-app",
        "--image", "europe-west1-docker.pkg.dev/$PROJECT_ID/hello-app/hello-app:latest",
        "--region", "europe-west1",
        "--platform", "managed",
        "--allow-unauthenticated"
      ]
    id: "Deploy"
    waitFor: ["Push Docker"]

  # 4) Smoke test
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - -c
      - |
        echo "Running smoke test..."
        URL=$(gcloud run services describe hello-app --region europe-west1 --format='value(status.url)')
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" $URL/health)
        
        echo "Smoke test status: $STATUS"
        
        if [ "$STATUS" -ne 200 ]; then
          echo "❌ Smoke test failed!"
          exit 1
        fi
        
        echo "✅ Smoke test passed!"
    id: "Smoke Test"
    waitFor: ["Deploy"]

images:
  - "europe-west1-docker.pkg.dev/$PROJECT_ID/hello-app/hello-app:latest"

serviceAccount: "cloud-run-deployer@ci-cd-cloudrun.iam.gserviceaccount.com"