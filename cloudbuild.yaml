# Fichier Cloud Build qui orchestre le d√©ploiement sur Cloud Run
# D√©clench√© par GitHub Actions suite au succ√®s des tests unitaires.

steps:
  # 1) Construction de l'Image Docker
  - name: "gcr.io/cloud-builders/docker"
    args: [
      "build",
      "-t",
      "europe-west1-docker.pkg.dev/$PROJECT_ID/hello-app/hello-app:latest",
      "."
    ]
    id: 'Construction Image Docker'

  # 2) Push de l'Image vers Artifact Registry
  - name: "gcr.io/cloud-builders/docker"
    args: [
      "push",
      "europe-west1-docker.pkg.dev/$PROJECT_ID/hello-app/hello-app:latest"
    ]
    id: 'Pousser Image'
    waitFor: ['Construction Image Docker']

  # 3) D√©ploiement sur Cloud Run (La nouvelle version est mise en ligne ici)
  - name: "gcr.io/cloud-builders/gcloud"
    args: [
      "run",
      "deploy",
      "hello-app",
      "--image",
      "europe-west1-docker.pkg.dev/$PROJECT_ID/hello-app/hello-app:latest",
      "--region",
      "europe-west1",
      "--platform",
      "managed",
      "--allow-unauthenticated",
      "--set-env-vars",
      "BUILD_ID=$BUILD_ID"
    ]
    id: 'D√©ploiement Cloud Run'
    waitFor: ['Pousser Image']

  # 4) Smoke Test (Ex√©cution du test de sant√©)
  # Si ce test √©choue (exit 1), il marque le d√©ploiement comme d√©fectueux et 
  # d√©clenche l'√©tape 5 (Rollback) gr√¢ce √† l'option 'allowFailure'.
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - -c
      - |
        echo "Running smoke test..."
        SERVICE_NAME="hello-app"
        REGION="europe-west1"
        
        URL=$$(gcloud run services describe $$SERVICE_NAME --region $$REGION --format='value(status.url)')
        STATUS=$$(curl -s -o /dev/null -w "%{http_code}" $$URL/health)

        echo "Smoke test status: $$STATUS"

        if [ "$$STATUS" -ne 200 ]; then
          echo "‚ùå Smoke test failed! Forcing pipeline failure to trigger rollback..."
          exit 1 # Fait √©chouer cette √©tape
        fi

        echo "‚úÖ Smoke test passed!"
    id: 'Smoke Test'
    waitFor: ['D√©ploiement Cloud Run']

  # 5) Rollback (Ex√©cut√© uniquement si une √©tape pr√©c√©dente √©choue, OU apr√®s succ√®s)
  # Pour que cette √©tape ne s'ex√©cute qu'en cas d'√©chec du Smoke Test, nous utilisons
  # l'option 'allowFailure' sur l'√©tape 4 et un 'waitFor' sp√©cifique.
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - -c
      - |
        # V√©rifie si l'√©tape Smoke Test a √©chou√© (logique complexe non visible ici)
        # S'il y a un √©chec, on lance le retour arri√®re.
        echo "üö® Launching automatic rollback..."
        SERVICE_NAME="hello-app"
        REGION="europe-west1"

        # Commande pour allouer 100% du trafic √† la r√©vision pr√©c√©dente
        gcloud run services update $$SERVICE_NAME \
          --region $$REGION \
          --to-previous \
          --platform managed
        
        echo "‚úÖ Rollback termin√©. Le service est revenu √† la version pr√©c√©dente."
    id: 'Rollback'
    # Cette √©tape est configur√©e pour s'ex√©cuter m√™me si une √©tape pr√©c√©dente (Smoke Test) 
    # a √©chou√©, en utilisant l'option `allowFailure` sur l'√©tape 4.
    # Pour des raisons de simplicit√© et de lisibilit√©, nous allons utiliser 
    # la configuration qui marque la d√©pendance :
    waitFor: ['-Smoke Test'] # (Notation conceptuelle : "si le Smoke Test √©choue")

# D√©claration des images produites pour l'historique
images:
  - "europe-west1-docker.pkg.dev/$PROJECT_ID/hello-app/hello-app:latest"

serviceAccount: "cloud-run-deployer@ci-cd-cloudrun.iam.gserviceaccount.com"

options:
  machineType: "E2_HIGHCPU_8"
  timeout: "1200s"