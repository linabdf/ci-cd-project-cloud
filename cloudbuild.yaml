# Fichier Cloud Build qui orchestre le d√©ploiement sur Cloud Run
# CORRECTION: machineType et timeout sont √† la racine.

steps:
  # 1) Construction de l'Image Docker
  - name: "gcr.io/cloud-builders/docker"
    args: [
      "build",
      "-t",
      "europe-west1-docker.pkg.dev/$PROJECT_ID/hello-app/hello-app:latest",
      "."
    ]
    id: 'Construction Image Docker'

  # 2) Push de l'Image vers Artifact Registry
  - name: "gcr.io/cloud-builders/docker"
    args: [
      "push",
      "europe-west1-docker.pkg.dev/$PROJECT_ID/hello-app/hello-app:latest"
    ]
    id: 'Pousser Image'
    waitFor: ['Construction Image Docker']

  # 3) D√©ploiement sur Cloud Run
  - name: "gcr.io/cloud-builders/gcloud"
    args: [
      "run",
      "deploy",
      "hello-app",
      "--image",
      "europe-west1-docker.pkg.dev/$PROJECT_ID/hello-app/hello-app:latest",
      "--region",
      "europe-west1",
      "--platform",
      "managed",
      "--allow-unauthenticated",
      "--set-env-vars",
      "BUILD_ID=$BUILD_ID"
    ]
    id: 'D√©ploiement Cloud Run'
    waitFor: ['Pousser Image']

  # 4) Smoke Test (Le test de sant√© qui doit √©chouer si le d√©ploiement est mauvais)
  # Nous utilisons 'allowFailure: true' pour que l'√©tape 5 puisse s'ex√©cuter m√™me en cas d'√©chec
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - -c
      - |
        echo "Running smoke test..."
        SERVICE_NAME="hello-app"
        REGION="europe-west1"
        
        URL=$$(gcloud run services describe $$SERVICE_NAME --region $$REGION --format='value(status.url)')
        STATUS=$$(curl -s -o /dev/null -w "%{http_code}" $$URL/health)

        echo "Smoke test status: $$STATUS"

        if [ "$$STATUS" -ne 200 ]; then
          echo "‚ùå Smoke test failed! Will proceed to rollback..."
          exit 1 # L'√©chec de cette √©tape d√©clenchera la logique de rollback
        fi

        echo "‚úÖ Smoke test passed!"
    id: 'Smoke Test'
    waitFor: ['D√©ploiement Cloud Run']
    allowFailure: true # PERMET AU PIPELINE DE CONTINUER M√äME SI LE TEST √âCHOUE

  # 5) Rollback (Ex√©cut√© si le Smoke Test a √©chou√©)
  # Cette √©tape ne s'ex√©cutera qu'APR√àS l'√©tape 4.
  # Elle doit contenir une logique conditionnelle v√©rifiant le succ√®s de l'√©tape 4.
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - -c
      - |
        # V√©rifie si l'√©tape pr√©c√©dente (Smoke Test) a √âCHOU√â (gr√¢ce au statut de sortie non nul)
        # La variable $$CLOUD_BUILD_STATUS n'est pas fiable. On utilise un trick bas√© sur le statut.
        # En Cloud Build, si l'√©tape 4 est allowFailure: true, nous devons v√©rifier explicitement.
        # Pour cet exercice, nous simplifions: si l'√©tape 4 a √©chou√©, l'√©tape 5 doit √™tre lanc√©e.

        # Logique simplifi√©e: si le Smoke Test a eu un code de sortie non nul (failed)
        if [ "$$STATUS_SMOKE_TEST" -ne 0 ]; then
            echo "üö® ATTENTION: D√©ploiement √©chou√© au Smoke Test. Lancement du Rollback..."
            SERVICE_NAME="hello-app"
            REGION="europe-west1"

            # Commande pour allouer 100% du trafic √† la r√©vision pr√©c√©dente
            gcloud run services update $$SERVICE_NAME \
              --region $$REGION \
              --to-previous \
              --platform managed
        
            echo "‚úÖ Rollback termin√©. Le service est revenu √† la version pr√©c√©dente."
        else
            echo "Rollback non n√©cessaire, le Smoke Test a r√©ussi."
        fi
    id: 'Rollback'
    # L'√©tape 5 d√©pend uniquement de la fin de l'√©tape 4.
    waitFor: ['Smoke Test']


# D√©claration des images produites pour l'historique
images:
  - "europe-west1-docker.pkg.dev/$PROJECT_ID/hello-app/hello-app:latest"

# Configuration des permissions
serviceAccount: "cloud-run-deployer@ci-cd-cloudrun.iam.gserviceaccount.com"

# ------------------------------------------------------------------
# CORRECTION : Ces options sont √† la RACINE du fichier pour √©viter l'erreur "unused"
# ------------------------------------------------------------------
timeout: "1200s"
machineType: "E2_HIGHCPU_8"

options:
  # Seule l'option 'logging' est conserv√©e dans le bloc 'options'
  logging: CLOUD_LOGGING_ONLY